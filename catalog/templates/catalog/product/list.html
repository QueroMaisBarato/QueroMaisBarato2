{% extends "catalog/base.html" %}
{% load static %}

{% block title %}
{% if category %}{{ category.name }}{% else %}Nossos Produtos{% endif %}
{% endblock %}

{% block content %}
<!-- Container Principal -->
<div class="flex flex-col gap-8">
    <!-- Lista de Produtos -->
    <div id="produtos">
        <form method="get" class="px-4 py-3">
            <label class="flex flex-col min-w-40 h-12 w-full">
                <div class="flex w-full flex-1 items-stretch rounded-xl h-full">
                    <div class="text-[#5c748a] flex border-none bg-[#eaedf1] items-center justify-center pl-4 rounded-l-xl border-r-0">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256">
                            <path d="M229.66,218.34l-50.07-50.06a88.11,88.11,0,1,0-11.31,11.31l50.06,50.07a8,8,0,0,0,11.32-11.32ZM40,112a72,72,0,1,1,72,72A72.08,72.08,0,0,1,40,112Z"></path>
                        </svg>
                    </div>
                    <input name="q" value="{{ query|default:'' }}" placeholder="Buscar produtos" class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-xl text-[#101518] focus:outline-0 focus:ring-0 border-none bg-[#eaedf1] focus:border-none h-full placeholder:text-[#5c748a] px-4 rounded-l-none border-l-0 pl-2 text-base font-normal leading-normal" />
                </div>
            </label>
        </form>

        <div class="flex gap-3 p-3 pr-4 overflow-x-auto flex-nowrap whitespace-nowrap scrollbar-thin scrollbar-thumb-[#eaedf1] scrollbar-track-transparent">
            <a href="{% url 'catalog:home' %}" class="flex h-8 shrink-0 items-center justify-center gap-x-2 rounded-xl {% if not category %}bg-[#101518] text-white{% else %}bg-[#eaedf1] text-[#101518]{% endif %} pl-4 pr-4">
                <p class="text-sm font-medium leading-normal">Todos os Produtos</p>
            </a>
            {% for c in categories %}
            <a href="{{ c.get_absolute_url }}" class="flex h-8 shrink-0 items-center justify-center gap-x-2 rounded-xl {% if category.slug == c.slug %}bg-[#101518] text-white{% else %}bg-[#eaedf1] text-[#101518]{% endif %} pl-4 pr-4">
                <p class="text-sm font-medium leading-normal">{{ c.name }}</p>
            </a>
            {% endfor %}
        </div>

        <div id="product-list" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 p-4">
            {% for product in products %}
                {% include "catalog/product/_card.html" %}
            {% endfor %}
            {% if not products %}
            <div class="col-span-full text-center py-8">
                <p class="text-[#5c748a] text-base font-normal leading-normal">Nenhum produto encontrado.</p>
            </div>
            {% endif %}
        </div>

        {% if products.has_next %}
        <div class="flex justify-center mt-6">
            <button id="load-more" class="relative inline-flex items-center px-4 py-2 rounded-md border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50" data-next-page="{{ products.next_page_number }}" data-query="{{ query|default:'' }}">Ver mais produtos</button>
        </div>
        {% endif %}
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const loadMoreButton = document.getElementById('load-more');
    const productList = document.getElementById('product-list');

    if (loadMoreButton) {
        loadMoreButton.addEventListener('click', function() {
            const nextPage = loadMoreButton.getAttribute('data-next-page');
            const query = loadMoreButton.getAttribute('data-query');
            const url = `?page=${nextPage}&q=${encodeURIComponent(query)}`;

            fetch(url, {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                // Adiciona os novos produtos ao grid
                productList.insertAdjacentHTML('beforeend', data.html);

                // Atualiza o botão "Ver mais produtos"
                if (data.has_next) {
                    loadMoreButton.setAttribute('data-next-page', data.next_page);
                } else {
                    loadMoreButton.remove(); // Remove o botão se não houver mais páginas
                }
            })
            .catch(error => console.error('Erro ao carregar produtos:', error));
        });
    }
});
</script>
{% endblock %}