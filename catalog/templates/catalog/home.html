{% extends "catalog/base.html" %}
{% load static %}

{% block title %}Início{% endblock %}

{% block content %}
<div id="produtos">
    <div id="product-list">
        {% include "catalog/product/_card.html" %}
    </div>

    {% if products_has_next %}
    <div class="flex justify-center mt-6">
        <button id="load-more" class="px-4 py-2 rounded-md border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50" data-next-page="{{ products.next_page_number }}" data-query="{{ query|default:'' }}">Ver mais produtos</button>
    </div>
    {% else %}
    <p class="text-center mt-6">Não há mais produtos para carregar.</p>
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const loadMoreButton = document.getElementById('load-more');
    const productList = document.getElementById('product-list');
    let isFetching = false;

    if (loadMoreButton) {
        loadMoreButton.addEventListener('click', function() {
            if (isFetching) return;
            isFetching = true;

            const nextPage = loadMoreButton.getAttribute('data-next-page');
            const query = loadMoreButton.getAttribute('data-query');
            const url = `?page=${nextPage}&q=${encodeURIComponent(query)}`;

            console.log(`Requisição AJAX para página ${nextPage}`);
            fetch(url, {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Erro AJAX: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                const parser = new DOMParser();
                const doc = parser.parseFromString(data.html, 'text/html');
                const productIds = Array.from(doc.querySelectorAll('.product-card')).map(el => el.getAttribute('data-product-id'));
                console.log(`Página ${nextPage}: ${productIds.length} produtos retornados`, productIds);

                productList.insertAdjacentHTML('beforeend', data.html);

                const newProducts = Array.from(productList.querySelectorAll('.product-card')).map(el => el.getAttribute('data-product-id'));
                console.log(`Após página ${nextPage}: ${newProducts.length} produtos no DOM`, newProducts);

                if (data.has_next) {
                    loadMoreButton.setAttribute('data-next-page', data.next_page);
                    loadMoreButton.textContent = 'Ver mais produtos';
                } else {
                    loadMoreButton.remove();
                }
                isFetching = false;
            })
            .catch(error => {
                console.error('Erro ao carregar produtos:', error);
                loadMoreButton.textContent = 'Ver mais produtos';
                isFetching = false;
            });
        });
    }
});
</script>
{% endblock %}