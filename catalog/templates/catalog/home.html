{% extends "catalog/base.html" %}
{% load static %}

{% block title %}Início{% endblock %}

{% block content %}
<div id="produtos">
    <div id="product-list" class="grid grid-cols-1 gap-6 p-4">
        {% for product in products %}
            {% include "catalog/product/_card.html" %}
        {% empty %}
            <p>Nenhum produto encontrado.</p>
        {% endfor %}
    </div>

    {% if products.has_next %}
    <div class="flex justify-center mt-6">
        <button id="load-more" class="px-4 py-2 rounded-md border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50" data-next-page="{{ products.next_page_number }}" data-query="{{ query|default:'' }}">Ver mais produtos</button>
    </div>
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const loadMoreButton = document.getElementById('load-more');
    const productList = document.getElementById('product-list');
    let isFetching = false;

    if (loadMoreButton) {
        loadMoreButton.addEventListener('click', function() {
            if (isFetching) return;
            isFetching = true;

            const nextPage = loadMoreButton.getAttribute('data-next-page');
            const query = loadMoreButton.getAttribute('data-query');
            const url = `?page=${nextPage}&q=${encodeURIComponent(query)}`;

            // Log: produtos no DOM antes da requisição
            const existingProducts = Array.from(productList.querySelectorAll('.product-card')).map(el => el.getAttribute('data-product-id'));
            console.log(`Antes da página ${nextPage}: ${existingProducts.length} produtos no DOM`, existingProducts);

            loadMoreButton.disabled = true;
            loadMoreButton.textContent = 'Carregando...';

            fetch(url, {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Erro AJAX: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                // Log: produtos retornados
                const parser = new DOMParser();
                const doc = parser.parseFromString(data.html, 'text/html');
                const productIds = Array.from(doc.querySelectorAll('.product-card')).map(el => el.getAttribute('data-product-id'));
                console.log(`Página ${nextPage}: ${productIds.length} produtos retornados`, productIds);

                // Verifica duplicatas
                const duplicates = productIds.filter(id => existingProducts.includes(id));
                if (duplicates.length > 0) {
                    console.warn(`Duplicatas na página ${nextPage}:`, duplicates);
                }

                // Anexa os novos produtos
                productList.insertAdjacentHTML('beforeend', data.html);

                // Log: produtos no DOM após anexação
                const newProducts = Array.from(productList.querySelectorAll('.product-card')).map(el => el.getAttribute('data-product-id'));
                console.log(`Após a página ${nextPage}: ${newProducts.length} produtos no DOM`, newProducts);

                // Atualiza o botão
                if (data.has_next) {
                    loadMoreButton.setAttribute('data-next-page', data.next_page);
                    loadMoreButton.disabled = false;
                    loadMoreButton.textContent = 'Ver mais produtos';
                } else {
                    loadMoreButton.remove();
                }
                isFetching = false;
            })
            .catch(error => {
                console.error('Erro ao carregar produtos:', error);
                loadMoreButton.disabled = false;
                loadMoreButton.textContent = 'Ver mais produtos';
                isFetching = false;
            });
        });
    }
});
</script>
{% endblock %}